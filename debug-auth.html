<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Debug Tool</title>
  <style>
    body {
      font-family: monospace;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #00ff00;
    }
    
    .section {
      border: 1px solid #333;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
    
    button {
      background: #333;
      color: #00ff00;
      border: 1px solid #666;
      padding: 8px 12px;
      margin: 5px;
      cursor: pointer;
      border-radius: 3px;
    }
    
    button:hover {
      background: #444;
    }
    
    pre {
      background: #000;
      padding: 10px;
      border-radius: 3px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    .status {
      font-weight: bold;
      font-size: 14px;
    }
    
    .success { color: #00ff00; }
    .error { color: #ff0000; }
    .warning { color: #ffaa00; }
  </style>
</head>
<body>
  <h1>üîç YouTube Summarizer Auth Debug Tool</h1>
  
  <div class="section">
    <h3>üì± Web App Authentication Status</h3>
    <div class="status" id="web-status">Checking...</div>
    <pre id="web-details">Loading...</pre>
    <button onclick="checkWebAuth()">Refresh Web Auth Status</button>
    <button onclick="clearWebAuth()">Clear Web Auth</button>
  </div>
  
  <div class="section">
    <h3>üß© Extension Authentication Status</h3>
    <div class="status" id="extension-status">Checking...</div>
    <pre id="extension-details">Loading...</pre>
    <button onclick="checkExtensionAuth()">Check Extension Auth</button>
    <button onclick="clearExtensionAuth()">Clear Extension Auth</button>
  </div>
  
  <div class="section">
    <h3>üåê Backend Connection Test</h3>
    <div class="status" id="backend-status">Checking...</div>
    <pre id="backend-details">Loading...</pre>
    <button onclick="testBackendConnection()">Test Backend</button>
  </div>
  
  <div class="section">
    <h3>üîß Actions</h3>
    <button onclick="syncExtensionAuth()">Sync Web ‚Üí Extension</button>
    <button onclick="testTokenVerification()">Test Token Verification</button>
    <button onclick="clearAllAuth()">Clear All Auth Data</button>
  </div>
  
  <div class="section">
    <h3>üìù Debug Log</h3>
    <pre id="debug-log">Debug log will appear here...\n</pre>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <script>
    const BACKEND_URL = 'http://localhost:3001/api';
    
    function log(message) {
      const timestamp = new Date().toLocaleTimeString();
      const logElement = document.getElementById('debug-log');
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
      console.log(message);
    }
    
    function clearLog() {
      document.getElementById('debug-log').textContent = 'Debug log cleared...\n';
    }
    
    async function checkWebAuth() {
      log('üîç Checking web app authentication...');
      
      const token = localStorage.getItem('youtube_summarizer_token');
      const user = localStorage.getItem('youtube_summarizer_user');
      
      const status = document.getElementById('web-status');
      const details = document.getElementById('web-details');
      
      if (token && user) {
        try {
          const userData = JSON.parse(user);
          status.textContent = '‚úÖ Authenticated';
          status.className = 'status success';
          details.textContent = JSON.stringify({
            hasToken: !!token,
            tokenLength: token.length,
            user: {
              name: userData.name,
              email: userData.email,
              subscription: userData.subscription
            }
          }, null, 2);
          
          log(`‚úÖ Web auth found: ${userData.name} (${userData.email})`);
        } catch (error) {
          status.textContent = '‚ùå Invalid Data';
          status.className = 'status error';
          details.textContent = `Error parsing user data: ${error.message}`;
          log(`‚ùå Web auth data corrupted: ${error.message}`);
        }
      } else {
        status.textContent = 'üîê Not Authenticated';
        status.className = 'status warning';
        details.textContent = JSON.stringify({
          hasToken: !!token,
          hasUser: !!user
        }, null, 2);
        
        log('üîê No web authentication found');
      }
    }
    
    async function checkExtensionAuth() {
      log('üîç Checking extension authentication...');
      
      if (typeof chrome === 'undefined' || !chrome.storage) {
        const status = document.getElementById('extension-status');
        const details = document.getElementById('extension-details');
        
        status.textContent = '‚ùå Extension API Not Available';
        status.className = 'status error';
        details.textContent = 'This debug tool needs to run as a Chrome extension or in extension context';
        
        log('‚ùå Chrome extension API not available');
        return;
      }
      
      try {
        const result = await chrome.storage.local.get(['youtube_summarizer_token', 'youtube_summarizer_user']);
        
        const status = document.getElementById('extension-status');
        const details = document.getElementById('extension-details');
        
        if (result.youtube_summarizer_token && result.youtube_summarizer_user) {
          const userData = JSON.parse(result.youtube_summarizer_user);
          
          status.textContent = '‚úÖ Extension Authenticated';
          status.className = 'status success';
          details.textContent = JSON.stringify({
            hasToken: !!result.youtube_summarizer_token,
            tokenLength: result.youtube_summarizer_token.length,
            user: {
              name: userData.name,
              email: userData.email,
              subscription: userData.subscription
            }
          }, null, 2);
          
          log(`‚úÖ Extension auth found: ${userData.name} (${userData.email})`);
        } else {
          status.textContent = 'üîê Extension Not Authenticated';
          status.className = 'status warning';
          details.textContent = JSON.stringify({
            hasToken: !!result.youtube_summarizer_token,
            hasUser: !!result.youtube_summarizer_user
          }, null, 2);
          
          log('üîê No extension authentication found');
        }
      } catch (error) {
        log(`‚ùå Extension auth check failed: ${error.message}`);
      }
    }
    
    async function testBackendConnection() {
      log('üåê Testing backend connection...');
      
      const status = document.getElementById('backend-status');
      const details = document.getElementById('backend-details');
      
      try {
        const response = await fetch(`${BACKEND_URL}/health`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          status.textContent = '‚úÖ Backend Online';
          status.className = 'status success';
          details.textContent = JSON.stringify(data, null, 2);
          log('‚úÖ Backend connection successful');
        } else {
          status.textContent = '‚ùå Backend Error';
          status.className = 'status error';
          details.textContent = `HTTP ${response.status}: ${response.statusText}`;
          log(`‚ùå Backend returned error: ${response.status}`);
        }
      } catch (error) {
        status.textContent = '‚ùå Backend Offline';
        status.className = 'status error';
        details.textContent = error.message;
        log(`‚ùå Backend connection failed: ${error.message}`);
      }
    }
    
    async function testTokenVerification() {
      log('üîê Testing token verification...');
      
      const token = localStorage.getItem('youtube_summarizer_token');
      if (!token) {
        log('‚ùå No token found to verify');
        return;
      }
      
      try {
        const response = await fetch(`${BACKEND_URL}/auth/me`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          log(`‚úÖ Token verification successful: ${data.user.name}`);
        } else {
          log(`‚ùå Token verification failed: HTTP ${response.status}`);
        }
      } catch (error) {
        log(`‚ùå Token verification error: ${error.message}`);
      }
    }
    
    function clearWebAuth() {
      localStorage.removeItem('youtube_summarizer_token');
      localStorage.removeItem('youtube_summarizer_user');
      log('üóëÔ∏è Web authentication cleared');
      checkWebAuth();
    }
    
    async function clearExtensionAuth() {
      if (typeof chrome !== 'undefined' && chrome.storage) {
        await chrome.storage.local.remove(['youtube_summarizer_token', 'youtube_summarizer_user']);
        log('üóëÔ∏è Extension authentication cleared');
        checkExtensionAuth();
      } else {
        log('‚ùå Cannot clear extension auth - Chrome API not available');
      }
    }
    
    function clearAllAuth() {
      clearWebAuth();
      clearExtensionAuth();
      log('üóëÔ∏è All authentication data cleared');
    }
    
    async function syncExtensionAuth() {
      log('üîÑ Syncing web ‚Üí extension authentication...');
      
      const token = localStorage.getItem('youtube_summarizer_token');
      const user = localStorage.getItem('youtube_summarizer_user');
      
      if (!token || !user) {
        log('‚ùå No web authentication to sync');
        return;
      }
      
      if (typeof chrome !== 'undefined' && chrome.runtime) {
        try {
          const userData = JSON.parse(user);
          
          // Send to extension background script
          chrome.runtime.sendMessage({
            action: 'storeUserToken',
            token: token,
            user: userData
          }, (response) => {
            if (response && response.success) {
              log('‚úÖ Authentication synced to extension');
              checkExtensionAuth();
            } else {
              log('‚ùå Failed to sync to extension');
            }
          });
        } catch (error) {
          log(`‚ùå Sync failed: ${error.message}`);
        }
      } else {
        log('‚ùå Cannot sync - Chrome extension API not available');
      }
    }
    
    // Initialize checks
    window.onload = () => {
      log('üöÄ Auth debug tool loaded');
      checkWebAuth();
      checkExtensionAuth();
      testBackendConnection();
    };
  </script>
</body>
</html>
