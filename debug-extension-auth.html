<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extension Auth Debug Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #8b5cf6;
            padding-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover { background: #7c3aed; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #8b5cf6;
            overflow-x: auto;
            font-size: 12px;
        }
        .auth-data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .test-result {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîç Extension Authentication Debug Tool</h1>
    
    <div class="container">
        <h2>üìä Current Authentication Status</h2>
        <div id="auth-status">Loading...</div>
    </div>

    <div class="grid">
        <div class="container">
            <h2>üåê Web App localStorage</h2>
            <div id="webapp-storage"></div>
            <button onclick="refreshWebAppStorage()">üîÑ Refresh</button>
            <button onclick="clearWebAppStorage()">üóëÔ∏è Clear</button>
        </div>

        <div class="container">
            <h2>üß© Extension chrome.storage.local</h2>
            <div id="extension-storage">
                <div class="warning">Extension storage can only be checked from the extension context</div>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üåâ Auth Bridge Status</h2>
        <div id="bridge-status"></div>
        <button onclick="testAuthBridge()">üîß Test Auth Bridge</button>
        <button onclick="triggerManualSync()">üîÑ Manual Sync</button>
    </div>

    <div class="container">
        <h2>üß™ Authentication Tests</h2>
        <div id="test-results"></div>
        <button onclick="runAllTests()">üöÄ Run All Tests</button>
        <button onclick="simulateSignIn()">‚úÖ Simulate Sign-In</button>
        <button onclick="simulateSignOut()">‚ùå Simulate Sign-Out</button>
    </div>

    <div class="container">
        <h2>üìã Debug Console</h2>
        <pre id="debug-console">Starting debug tool...\n</pre>
        <button onclick="clearDebugConsole()">üßπ Clear Console</button>
    </div>

    <script>
        // Debug logging function
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const console = document.getElementById('debug-console');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            console.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            console.scrollTop = console.scrollHeight;
            
            // Also log to browser console
            if (type === 'error') console.error(message);
            else if (type === 'warning') console.warn(message);
            else console.log(message);
        }

        // Check web app localStorage
        function checkWebAppStorage() {
            const token = localStorage.getItem('youtube_summarizer_token');
            const user = localStorage.getItem('youtube_summarizer_user');
            
            const status = {
                hasToken: !!token,
                hasUser: !!user,
                tokenLength: token ? token.length : 0,
                userData: null
            };

            if (user) {
                try {
                    status.userData = JSON.parse(user);
                } catch (e) {
                    status.parseError = e.message;
                }
            }

            return status;
        }

        // Update web app storage display
        function refreshWebAppStorage() {
            const storage = checkWebAppStorage();
            const container = document.getElementById('webapp-storage');
            
            let html = '';
            if (storage.hasToken) {
                html += `<div class="auth-data">
                    <strong>Token:</strong> Present (${storage.tokenLength} characters)<br>
                    <strong>User:</strong> ${storage.userData ? storage.userData.name + ' (' + storage.userData.email + ')' : 'Invalid JSON'}
                </div>`;
            } else {
                html += '<div class="warning">No authentication data found</div>';
            }

            if (storage.parseError) {
                html += `<div class="error">JSON Parse Error: ${storage.parseError}</div>`;
            }

            container.innerHTML = html;
            debugLog('Web app storage refreshed');
        }

        // Clear web app storage
        function clearWebAppStorage() {
            localStorage.removeItem('youtube_summarizer_token');
            localStorage.removeItem('youtube_summarizer_user');
            refreshWebAppStorage();
            debugLog('Web app storage cleared', 'warning');
        }

        // Check auth bridge status
        function checkAuthBridge() {
            const bridge = window.youTubeSummarizerAuthBridge;
            const container = document.getElementById('bridge-status');
            
            if (bridge) {
                const authState = bridge.getAuthState();
                container.innerHTML = `
                    <div class="success">‚úÖ Auth Bridge is loaded and available</div>
                    <div class="auth-data">
                        <strong>Last Auth State:</strong><br>
                        ${authState ? JSON.stringify(authState, null, 2) : 'Not yet initialized'}
                    </div>
                `;
                debugLog('Auth bridge is available', 'success');
                return true;
            } else {
                container.innerHTML = '<div class="error">‚ùå Auth Bridge is not loaded</div>';
                debugLog('Auth bridge is not available', 'error');
                return false;
            }
        }

        // Test auth bridge functionality
        function testAuthBridge() {
            if (checkAuthBridge()) {
                try {
                    window.youTubeSummarizerAuthBridge.syncAuth();
                    debugLog('Auth bridge sync triggered successfully', 'success');
                } catch (error) {
                    debugLog(`Auth bridge sync failed: ${error.message}`, 'error');
                }
            }
        }

        // Trigger manual sync
        function triggerManualSync() {
            if (checkAuthBridge()) {
                debugLog('Triggering manual auth sync...', 'info');
                window.youTubeSummarizerAuthBridge.syncAuth();
                
                // Also try postMessage method
                window.postMessage({
                    type: 'YOUTUBE_SUMMARIZER_AUTH_SYNC'
                }, window.location.origin);
                
                debugLog('Manual sync triggered via both methods', 'success');
            }
        }

        // Update overall auth status
        function updateAuthStatus() {
            const webStorage = checkWebAppStorage();
            const hasBridge = !!window.youTubeSummarizerAuthBridge;
            const container = document.getElementById('auth-status');
            
            let status = '';
            
            if (webStorage.hasToken && webStorage.hasUser) {
                status += '<div class="success">‚úÖ Web App: Authenticated</div>';
            } else {
                status += '<div class="error">‚ùå Web App: Not Authenticated</div>';
            }
            
            if (hasBridge) {
                status += '<div class="success">‚úÖ Auth Bridge: Loaded</div>';
            } else {
                status += '<div class="error">‚ùå Auth Bridge: Not Loaded</div>';
            }
            
            container.innerHTML = status;
        }

        // Simulate sign in for testing
        function simulateSignIn() {
            const testUser = {
                id: 'test-user-123',
                name: 'Test User',
                email: 'test@example.com',
                picture: 'https://via.placeholder.com/96',
                role: 'user',
                subscription: { plan: 'free', status: 'active' },
                backendToken: 'test-jwt-token-' + Date.now()
            };
            
            localStorage.setItem('youtube_summarizer_token', testUser.backendToken);
            localStorage.setItem('youtube_summarizer_user', JSON.stringify(testUser));
            
            debugLog('Test sign-in simulated', 'success');
            refreshWebAppStorage();
            updateAuthStatus();
            
            // Trigger sync
            setTimeout(() => {
                if (window.youTubeSummarizerAuthBridge) {
                    window.youTubeSummarizerAuthBridge.syncAuth();
                    debugLog('Sync triggered after test sign-in', 'info');
                }
            }, 100);
        }

        // Simulate sign out for testing
        function simulateSignOut() {
            localStorage.removeItem('youtube_summarizer_token');
            localStorage.removeItem('youtube_summarizer_user');
            
            debugLog('Test sign-out simulated', 'warning');
            refreshWebAppStorage();
            updateAuthStatus();
            
            // Trigger sync
            setTimeout(() => {
                if (window.youTubeSummarizerAuthBridge) {
                    window.youTubeSummarizerAuthBridge.syncAuth();
                    debugLog('Sync triggered after test sign-out', 'info');
                }
            }, 100);
        }

        // Run comprehensive tests
        function runAllTests() {
            const results = document.getElementById('test-results');
            let html = '<h3>üß™ Running Authentication Tests...</h3>';
            
            const tests = [
                {
                    name: 'Web App localStorage Check',
                    test: () => {
                        const storage = checkWebAppStorage();
                        return storage.hasToken && storage.hasUser && !storage.parseError;
                    }
                },
                {
                    name: 'Auth Bridge Availability',
                    test: () => !!window.youTubeSummarizerAuthBridge
                },
                {
                    name: 'Auth Bridge Sync Function',
                    test: () => {
                        try {
                            return typeof window.youTubeSummarizerAuthBridge?.syncAuth === 'function';
                        } catch (e) {
                            return false;
                        }
                    }
                },
                {
                    name: 'Extension Context Available',
                    test: () => typeof chrome !== 'undefined' && !!chrome.runtime
                }
            ];

            tests.forEach(test => {
                try {
                    const result = test.test();
                    const status = result ? 'success' : 'error';
                    const icon = result ? '‚úÖ' : '‚ùå';
                    html += `<div class="test-result ${status}">${icon} ${test.name}: ${result ? 'PASS' : 'FAIL'}</div>`;
                    debugLog(`Test "${test.name}": ${result ? 'PASS' : 'FAIL'}`, result ? 'success' : 'error');
                } catch (error) {
                    html += `<div class="test-result error">‚ùå ${test.name}: ERROR - ${error.message}</div>`;
                    debugLog(`Test "${test.name}": ERROR - ${error.message}`, 'error');
                }
            });

            results.innerHTML = html;
        }

        function clearDebugConsole() {
            document.getElementById('debug-console').textContent = '';
        }

        // Initialize debug tool
        function init() {
            debugLog('Debug tool initialized');
            refreshWebAppStorage();
            checkAuthBridge();
            updateAuthStatus();
            
            // Monitor localStorage changes
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                originalSetItem.apply(this, arguments);
                if (key === 'youtube_summarizer_token' || key === 'youtube_summarizer_user') {
                    debugLog(`localStorage change detected: ${key}`, 'info');
                    setTimeout(() => {
                        refreshWebAppStorage();
                        updateAuthStatus();
                    }, 100);
                }
            };
            
            const originalRemoveItem = localStorage.removeItem;
            localStorage.removeItem = function(key) {
                originalRemoveItem.apply(this, arguments);
                if (key === 'youtube_summarizer_token' || key === 'youtube_summarizer_user') {
                    debugLog(`localStorage removal detected: ${key}`, 'warning');
                    setTimeout(() => {
                        refreshWebAppStorage();
                        updateAuthStatus();
                    }, 100);
                }
            };
            
            // Refresh every 5 seconds
            setInterval(() => {
                refreshWebAppStorage();
                updateAuthStatus();
                checkAuthBridge();
            }, 5000);
        }

        // Start when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
